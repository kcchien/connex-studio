# Implementation Plan: Remove Virtual Server

**Branch**: `004-remove-virtual-server` | **Date**: 2026-01-25 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-remove-virtual-server/spec.md`

## Summary

Remove the Virtual Server functionality from Connex Studio to transform it into a focused Protocol Client tool. This involves deleting 8 source code files (~1,800 lines), modifying 6 integration point files to remove Virtual Server references, and updating 4 specification documents to reflect the new product scope.

**Technical Approach**: Systematic deletion of Virtual Server code in reverse dependency order (UI → services → types), followed by integration point cleanup and documentation updates. Build verification ensures no dangling references.

## Technical Context

**Language/Version**: TypeScript 5.x, Node.js 22 LTS
**Runtime**: Electron 40
**Frontend**: React 19, Vite 6, Tailwind CSS, Shadcn/ui
**State Management**: Zustand with cross-process sync via IPC
**Primary Dependencies**: No new dependencies; removing modbus-serial TCP server usage
**Storage**: N/A for this removal task
**Testing**: Vitest (renderer unit), Jest (main process unit), Playwright (E2E)
**Target Platform**: Windows 10+, macOS 11+, Ubuntu 20.04+
**Project Type**: Electron (Main + Renderer processes)
**Performance Goals**: N/A (removal task; existing performance targets unaffected)
**Constraints**: Build must succeed after removal; existing tests must pass
**Scale/Scope**: 8 files to delete, 6 files to modify, 4 spec docs to update

## Constitution Check

*GATE: Must pass before implementation.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I.1 Spec-Driven Development | ✅ PASS | spec.md complete with 3 user stories, 17 FRs |
| I.2 Single Source of Truth | ✅ PASS | Removing unused code maintains SSOT clarity |
| I.3 Abstract Interfaces | ✅ PASS | ProtocolAdapter interface unaffected (client-side only) |
| I.4 Minimum Viable Complexity | ✅ PASS | Reducing codebase complexity by removing unused feature |
| II.1 Separate Data Types | ✅ PASS | No data model changes (pure removal) |
| II.2 Clear Update Flows | ✅ PASS | IPC channels being removed, not modified |
| III.1 Built-In Quality | ✅ PASS | Build verification step in spec (FR-016, FR-017) |
| III.2 Temporary Things Short-Lived | ✅ PASS | Removing feature aligns with principle |
| III.3 Risky Ops Confirmation | ✅ PASS | Deletion is reversible via git |
| IV.4 Keep a Changelog | ✅ PASS | Will update docs/CHANGELOG.md with "Removed" section |
| VI.2 IP & Confidentiality | ✅ PASS | No credential handling changes |

**Gate Result**: ✅ PASS - Proceed to implementation

## Project Structure

### Documentation (this feature)

```text
specs/004-remove-virtual-server/
├── spec.md              # Feature specification (complete)
├── plan.md              # This file
├── checklists/          # Quality checklists
│   └── requirements.md  # Spec quality validation (complete)
└── tasks.md             # Implementation tasks (to be generated by /speckit.tasks)
```

### Source Code Changes

#### Files to DELETE (8 files, ~1,800 lines)

```text
src/
├── main/
│   ├── ipc/virtual-server.ts              # 124 lines - IPC handlers
│   └── services/VirtualServer.ts          # 721 lines - Service implementation
├── renderer/
│   ├── components/virtual-server/         # 742 lines total
│   │   ├── VirtualServerPanel.tsx         # 254 lines - Main panel
│   │   ├── RegisterConfigForm.tsx         # 246 lines - Register config
│   │   ├── WaveformSelector.tsx           # 232 lines - Waveform UI
│   │   └── index.ts                       # 10 lines - Exports
│   └── stores/virtualServerStore.ts       # 110 lines - Zustand store
└── shared/
    └── types/virtual-server.ts            # 62 lines - Type definitions
```

#### Files to MODIFY (6 files)

```text
src/
├── main/
│   ├── ipc/index.ts                       # Remove handler registration
│   └── services/index.ts                  # Remove VirtualServer exports
├── preload/
│   └── index.ts                           # Remove virtualServer API
├── renderer/
│   └── App.tsx                            # Remove VirtualServerPanel
└── shared/
    ├── constants/ipc-channels.ts          # Remove virtual-server channels
    └── types/index.ts                     # Remove type re-exports
```

#### Spec Documents to UPDATE (4 files)

```text
specs/002-iiot-protocol-studio/
├── spec.md                                # Remove User Story 5
├── plan.md                                # Remove Phase 13 reference
├── data-model.md                          # Remove VirtualServer/VirtualRegister/Waveform
└── contracts/ipc-channels.md              # Remove virtual-server channels
```

**Structure Decision**: This is a pure removal task. No new directories or files are created. The existing Electron project structure remains unchanged.

## Complexity Tracking

> No violations - this task reduces complexity by removing unused code.

| Metric | Before | After | Change |
|--------|--------|-------|--------|
| Total source files | +8 VS files | 0 VS files | -8 files |
| Lines of code | ~1,800 VS lines | 0 VS lines | -1,800 lines |
| IPC channels | 3 VS channels | 0 VS channels | -3 channels |
| UI components | 3 VS components | 0 VS components | -3 components |

## Implementation Phases

### Phase 1: Source Code Deletion

**Sequence**: Delete in dependency order to avoid compilation errors during incremental deletion.

1. **Delete UI layer first** (no other code depends on it):
   - `src/renderer/components/virtual-server/` (entire directory)
   - `src/renderer/stores/virtualServerStore.ts`

2. **Delete IPC and service layer**:
   - `src/main/ipc/virtual-server.ts`
   - `src/main/services/VirtualServer.ts`

3. **Delete type definitions last** (after all consumers removed):
   - `src/shared/types/virtual-server.ts`

### Phase 2: Integration Point Cleanup

**Sequence**: Modify files to remove Virtual Server references.

1. Remove imports and exports:
   - `src/main/ipc/index.ts` - Remove handler registration
   - `src/main/services/index.ts` - Remove exports
   - `src/shared/types/index.ts` - Remove type re-exports

2. Remove API exposure:
   - `src/preload/index.ts` - Remove virtualServer API

3. Remove UI integration:
   - `src/renderer/App.tsx` - Remove VirtualServerPanel

4. Remove channel constants:
   - `src/shared/constants/ipc-channels.ts` - Remove VIRTUAL_SERVER_* channels

### Phase 3: Documentation Updates

1. Update `specs/002-iiot-protocol-studio/spec.md`:
   - Remove User Story 5 (Virtual Server for Testing)
   - Update priority numbering if needed

2. Update `specs/002-iiot-protocol-studio/plan.md`:
   - Remove Phase 13 (Virtual Server implementation)
   - Remove VirtualServer.ts from project structure

3. Update `specs/002-iiot-protocol-studio/data-model.md`:
   - Remove VirtualServer interface
   - Remove VirtualRegister interface
   - Remove Waveform interface

4. Update `specs/002-iiot-protocol-studio/contracts/ipc-channels.md`:
   - Remove virtual-server:start channel
   - Remove virtual-server:stop channel
   - Remove virtual-server:status channel

### Phase 4: Verification

1. Run TypeScript build: `pnpm typecheck`
2. Run all tests: `pnpm test`
3. Manual verification: Launch app and confirm no Virtual Server UI
4. Update CHANGELOG.md with "Removed" section

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Hidden dependencies on VS code | Low | Medium | Build verification catches compile errors |
| Tests referencing VS code | Low | Low | Test run identifies failures |
| Incomplete spec doc updates | Low | Low | Grep verification in success criteria |

## Artifacts Generated

Since this is a **removal** task (not a new feature), the following standard plan artifacts are **NOT applicable**:

- ~~research.md~~ - No technology decisions needed
- ~~data-model.md~~ - Removing entities, not adding
- ~~contracts/~~ - Removing channels, not adding
- ~~quickstart.md~~ - No new dev setup required

**Next Step**: Run `/speckit.tasks` to generate the implementation task list.
